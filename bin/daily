#! /app/.heroku/node/bin/node

require('dotenv').config();
const exec = require('child_process').exec

function os_func() {
        this.execCommand = function(cmd, callback) {
            exec(cmd, (error, stdout, stderr) => {
                if (error) {
                console.error(`exec error: ${error}`);
                return;
                 }
        callback(stdout);
        });
    }
}
var os = new os_func();

//Publications

//WSJ
const WSJ_file = "_wsj-today_";
const WSJ_recipe = "The Wall Street Journal.recipe";

//Seattle Times
const seattle_times_file = "_seattle-times_";
const seattle_times_recipe = "The Seattle Times.recipe";

function get_file(pub){
    if(pub === "WSJ") return WSJ_file;
}

function get_recipe(pub){
    if(pub === "WSJ") return WSJ_recipe;
    if(pub === "ST") return seattle_times_recipe;
}

function daily(pub) {
    //Generate master WSJ epub
    os.execCommand(`ebook-convert "The Wall Street Journal.recipe" ./pdfs/wsj-today.epub  --output-profile tablet --username ${process.env.wsj_username} --password ${process.env.wsj_password}`, function (returnvalue) {
        console.log("Generated master WSJ epub");

        //Check for WSJ file
        os.execCommand(`./rmapi find .`, function (returnvalue) {
            if (returnvalue.includes(`wsj-today`)){
                //Remove old WSJ
                os.execCommand(`./rmapi rm wsj-today`, function (returnvalue) {
                    console.log(`Removed old WSJ`);
                         //Send WSJ to rM
                         os.execCommand(`./rmapi put ./pdfs/wsj-today.epub`, function (returnvalue) {
                             console.log("Sent WSJ epub to rM");
                         });
                 });
             }
             else{
                 //Send WSJ to rM
                 os.execCommand(`./rmapi put ./pdfs/wsj-today.epub`, function (returnvalue) {
                     console.log("Sent WSJ epub to rM");
                 });
             }
        });

        //Generate WSJ mobi
        os.execCommand(`ebook-convert ./pdfs/wsj-today.epub ./pdfs/wsj-today.mobi --output-profile kindle_pw3 --mobi-file-type both`, function (returnvalue) {
            console.log("Generated WSJ mobi");

            //Email WSJ mobi to Kindle
            os.execCommand(`calibre-smtp --attachment ./pdfs/wsj-today.mobi --relay smtp.live.com --port 587 --username ${process.env.HOTMAIL_USERNAME} --password ${process.env.HOTMAIL_PASSWORD} ${process.env.HOTMAIL_USERNAME} ${process.env.KINDLE_EMAIL} ""`, function (returnvalue) {
            console.log(`Emailed WSJ mobi to Kindle`);
            });
        });
    });
}
daily("ST");
//daily("WSJ");